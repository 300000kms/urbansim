<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=1024, user-scalable=no">
<style>
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0;}
      #map{ height: 100% }

      .legend {
          line-height: 18px;
          color: #555;
      }
      .legend i {
          width: 15px;
          height: 15px;
          float: left;
          margin-right: 8px;
      }
      .info {
          padding: 6px 8px;
          font: 14px/16px Arial, Helvetica, sans-serif;
          background: white;
          background: rgba(255,255,255,0.8);
          box-shadow: 0 0 15px rgba(0,0,0,0.2);
          border-radius: 5px;
      }
      .info h4 {
          margin: 0 0 5px;
          color: #777;
      }
</style>

<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.4.8/d3.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular.js"></script>
<script src="http://colorbrewer2.org/export/colorbrewer.js"></script>
<script src="http://paris.urbansim.org/angular-slider/slider.js"></script>
<link rel="stylesheet" href="http://paris.urbansim.org/angular-slider/slider.css"/>

<script type="text/javascript">

SHAPE_JSON = "{{shape_json}}";
SIM_OUTPUT = {{sim_output}};
CENTER = {{center}};
ZOOM = {{zoom}};
PRECISION = {{precision}};
GEOMNAME = "{{geom_name}}";
JOINNAME = "{{join_name}}";
ROOT = "http://localhost:8765/"

MAP = null;
var shapeLayer = null;
var data = null;
var lastlegend = null;

var buckets = 7;
var color = 'YlGnBu';
var q = null;

app = angular.module('app', ['ui.slider']);

app.controller('SimCtrl', ['$scope', function controller($scope, $timeout) {
    MAP = L.map("map").setView(CENTER, ZOOM);


    L.tileLayer("http://otile1.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.jpg",
           {subdomains: '1234',type:'map',minZoom:8,maxZoom:16}).addTo(MAP);

    $scope.timeout = $timeout;
    $scope.sim_output = SIM_OUTPUT;
    $scope.years = $scope.sim_output["years"];
    $scope.year_range = {
        low: $scope.years[0],
        high: $scope.years[$scope.years.length-1]
    };
    $scope.field_names = [];
    $scope.norm_field_names = ['Normalize by'];
    Object.keys($scope.sim_output).forEach(function(a) {
        if(a != "index" && a != "years") {
            $scope.field_names.push(a);
            $scope.norm_field_names.push(a);
        }
    });
    $scope.field_name = $scope.field_names[0];
    $scope.norm_field_name = $scope.norm_field_names[0];
    $scope.colors = Object.keys(colorbrewer);
    $scope.color = "YlGnBu";
    $scope.scale_options = ["quantile", "equal_interval"];
    $scope.scale = "quantile";
    $scope.slider_type = "growth";

    $scope.$watch('year_range.low + year_range.high + year + field_name + ' +
                    'norm_field_name',
            function(nv, ov) {
        $scope.runQuery();
    });

    $scope.$watch('slider_type', function(nv, ov) {
        $scope.safeApply(function() {
            if(nv == "total") {
                $scope.year = $scope.year_range.high;
            } else if (ov == "total") {
                $scope.year_range.high = $scope.year;
            }
        });
        $scope.runQuery();
    });

    $scope.$watch('color', function(nv, ov) {
        color = $scope.color;
        $scope.setLegend();
        if(shapeLayer) shapeLayer.setStyle(style_f);
    });

    $scope.$watch('scale', function(nv, ov) {
        $scope.setScale();
        $scope.setLegend();
        if(shapeLayer) shapeLayer.setStyle(style_f);
    })

    $scope.$watch('data', function(nv, ov) {
        data = nv;

        $scope.setScale();
        $scope.setLegend();
        if(shapeLayer) shapeLayer.setStyle(style_f);
        $scope.setPopup();
    });

    $scope.safeApply = function(fn) {
        var phase = this.$root.$$phase;
        if(phase == '$apply' || phase == '$digest') {
            if(fn && (typeof(fn) === 'function')) {
                fn();
            }
        } else {
            this.$apply(fn);
        }
    };

    $scope.setScale = function() {
        if(!data) return;
        var values = Object.keys(data).map(function (key) {
            return data[key];
        });
        if(values.length == 0) {
            values = [0, 0];
        }
        if ($scope.scale == "quantile") {
            q = d3.scale.quantile()
                    .domain(values)
                    .range(d3.range(buckets));
        } else {
            q = d3.scale.quantize()
                    .domain(d3.extent(values))
                    .range(d3.range(buckets));
        }
    }

    $scope.setLegend = function() {
        if (!data || !MAP) return;
        if (lastlegend) lastlegend.removeFrom(MAP);

        var legend = L.control({position: 'bottomright'});

        legend.onAdd = function (map) {

            var div = L.DomUtil.create('div', 'info legend'),
                    grades = q.range(),
                    labels = [],
                    from, to;

            for (var i = grades.length-1; i >= 0; i--) {
                var extent = q.invertExtent(grades[i]);
                from = extent[0].toFixed(PRECISION);
                to = extent[1].toFixed(PRECISION);

                labels.push(
                                '<i style="background:' +
                                colorbrewer[color][buckets][i] + '"></i>' +
                                from + (to ? ' to ' + to : '+'));
            }

            div.innerHTML = labels.join('<br>');
            return div;
        };
        lastlegend = legend;
        legend.addTo(MAP);
    }

    $scope.setPopup = function() {
        Object.keys(feature_d).forEach(function(taz) {
            layer = feature_d[taz];
            val = data[taz];
            if(val != undefined) layer.bindPopup("zone: "+
                    taz+"<br>"+$scope.field_name+": "+
                    val.toFixed(PRECISION).toString());
            else layer.bindPopup("No value");
        })
    }

    $scope.runQuery = function() {
        if(!shapeLayer) return;

        // don't even need to call a query here since all the results are just
        // embedded in this html file
        keys = $scope.sim_output["index"];
        year_high = $scope.slider_type == "total" ?
                $scope.year : $scope.year_range.high;
        values = $scope.sim_output[$scope.field_name][year_high];
        values2 = $scope.sim_output[$scope.field_name][$scope.year_range.low];
        //values_tot = d3.sum(values);
        //values2_tot = d3.sum(values2);
        $scope.safeApply(function() {
            var map = {}
            for(var i in keys) {
                high_val = values[i];
                low_val = values2[i];
                if($scope.norm_field_name != 'Normalize by') {
                    high_val /=
                            $scope.sim_output[$scope.norm_field_name][year_high][i];
                    low_val /=
                            $scope.sim_output[$scope.norm_field_name][$scope.year_range.low][i];
                }
                if($scope.slider_type == "total") {
                    map[keys[i]] = high_val;
                } else if ($scope.slider_type == "growth") {
                    map[keys[i]] = high_val - low_val;
                } else if ($scope.slider_type == "pct growth") {
                    map[keys[i]] = (high_val - low_val) /
                            low_val * 100;
                    if(low_val == 0) {
                        map[keys[i]] = 0;
                    }
                }
            }
            $scope["data"] = map;
        });
    };

    $scope.advance = function (i) {
        if(i >= $scope.years.length) return;
        $scope.safeApply(function() {
            $scope.year_range.high = $scope.years[i];
        });
        setTimeout(function(){
            $scope.advance(i+1)
        }, 500);
    }

    $scope.play = function () {
        $scope.year_range.low = $scope.years[0];
        $scope.advance(0);
    }

    function style_f(feature) {
        if(data && q) {
            var val = data[feature.properties[GEOMNAME]];
            var v = q(val);
        }
        fo = .7;
        if(v == undefined) {
            v = 0;
            fo = 0.0;
        }
        if($scope.slider_type != "total" &&
                $scope.year_range.low == $scope.year_range.high) {
            v = 0;
            fo = 0.0;
        }
        var c = colorbrewer[color][buckets][v];

        return {
            fillColor: c,
            weight: 1,
            opacity: .6,
            color: 'black',
            fillOpacity: fo
        };
    }

    var feature_d = {}
    d3.json(SHAPE_JSON, function(error, zones) {
        if (error) return console.error(error);
        shapeLayer = new L.geoJson(zones, {
            style: style_f,
            onEachFeature: function (feature, layer) {
                feature_d[feature.properties[GEOMNAME]] = layer;
                //layer.bindPopup("No value");
            }
        });
        MAP.addLayer(shapeLayer);
        $scope.runQuery();
    });
}]);

</script>
</head>

<body ng-app="app" ng-controller="SimCtrl">

<div id="map"
     style="width:100%; height:100%; position:fixed; left:0; top:0;
     overflow:hidden;">
</div>

<div style="position:absolute; right: 320px; top: 12px; color: white">
<i ng-click="play()" class="fa fa-youtube-play fa-2x"></i>
</div>

<slider style="position:absolute; right: 10px; top: 0px; width: 300px;"
        floor="{% raw %}{{years[0]}}{% endraw %}"
        ceiling="{% raw %}{{years[years.length-1]}}{% endraw %}"
        ng-show="slider_type != 'total'"
        step="1" precision="0"
        ng-model-low="year_range.low" ng-model-high="year_range.high"></slider>

<slider style="position:absolute; right: 10px; top: 0px; width: 300px;"
        floor="{% raw %}{{years[0]}}{% endraw %}"
        ceiling="{% raw %}{{years[years.length-1]}}{% endraw %}"
        ng-show="slider_type == 'total'"
        step="1" precision="0"
        ng-model="year"></slider>

<select style="position:absolute; right: 10px; top: 45px; width: 150px;"
        ng-options="type for type in ['total', 'growth', 'pct growth']"
        ng-model="slider_type"></select>

<select style="position:absolute; right: 10px; top: 70px; width: 150px;"
        ng-options="name for name in field_names"
        ng-model="field_name"></select>

<select style="position:absolute; right: 10px; top: 95px; width: 150px;"
        ng-options="name for name in colors"
        ng-model="color"></select>

<select style="position:absolute; right: 10px; top: 120px; width: 150px;"
        ng-options="name for name in scale_options"
        ng-model="scale"></select>

<select style="position:absolute; right: 10px; top: 145px; width: 150px;"
        ng-options="name for name in norm_field_names"
        ng-model="norm_field_name"></select>

</body>
